# ğŸ¯ UniRigãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼çµ±åˆæ•´æµå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ - 2025å¹´6æœˆ14æ—¥

## ğŸ“‹ å®Ÿè£…æ¦‚è¦

**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸­å¿ƒè¨­è¨ˆã«ã‚ˆã‚‹çµ±ä¸€ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡ã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼æ•´æµã®å®Ÿè£…  
**æˆæœ**: åˆ†æ•£ãƒ»ä¸æ•´åˆã ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’äºˆæ¸¬å¯èƒ½ãªçµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ ã«å¤‰æ›  
**æŠ€è¡“çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: æ¼¸é€²çš„çµ±ä¸€ï¼ˆåŸæµå‡¦ç†äº’æ›æ€§ä¿æŒ + çµ±ä¸€å‘½åè¦å‰‡é©ç”¨ï¼‰

## âœ… å®Ÿè£…å®Œäº†é …ç›®

### 1. çµ±ä¸€å‘½åè¦å‰‡ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…

#### ğŸ”§ `FixedDirectoryManager` çµ±ä¸€å¯¾å¿œå®Œäº†
```python
# æ–°æ©Ÿèƒ½è¿½åŠ :
class UnifiedNamingConvention:
    NAMING_PATTERNS = {
        'step1': {'mesh_npz': '{model_name}_mesh.npz'},
        'step2': {
            'skeleton_fbx': '{model_name}_skeleton.fbx',
            'skeleton_npz': '{model_name}_skeleton.npz'
        },
        'step3': {
            'skinned_fbx': '{model_name}_skinned.fbx',
            'skinning_npz': '{model_name}_skinning.npz'
        },
        'step4': {'merged_fbx': '{model_name}_merged.fbx'},
        'step5': {'rigged_fbx': '{model_name}_rigged.fbx'}  # æœ€çµ‚æˆæœç‰©
    }
```

#### ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½å®Ÿè£…
```python
# ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ä¿æŒ:
def find_file_with_fallback(self, step: str, file_type: str) -> Optional[Path]:
    # 1. çµ±ä¸€å‘½åè¦å‰‡ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
    unified_path = self.get_unified_file_path(step, file_type)
    if unified_path.exists():
        return unified_path
    
    # 2. ãƒ¬ã‚¬ã‚·ãƒ¼å‘½åè¦å‰‡ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    legacy_names = self.naming.get_legacy_file_names(model_name, step, file_type)
    for legacy_name in legacy_names:
        legacy_path = step_dir / legacy_name
        if legacy_path.exists():
            return legacy_path
```

#### ğŸ¯ çµ±ä¸€å‡ºåŠ›ä¿è¨¼æ©Ÿèƒ½
```python
def ensure_unified_output(self, step: str, file_type: str, original_file: Path) -> Path:
    """åŸæµå‡¦ç†å‡ºåŠ›ã‚’çµ±ä¸€å‘½åè¦å‰‡ã«ãƒªãƒãƒ¼ãƒ /ã‚³ãƒ”ãƒ¼"""
    unified_path = self.get_unified_file_path(step, file_type)
    
    if original_file.exists() and original_file != unified_path:
        shutil.copy2(original_file, unified_path)
        self.logger.info(f"ğŸ”„ çµ±ä¸€å‘½åè¦å‰‡é©ç”¨: {original_file} â†’ {unified_path}")
    
    return unified_path
```

### 2. çµ±ä¸€Orchestratorå®Ÿè£…

#### ğŸ“¦ `unified_extract_streamlined.py` ä½œæˆå®Œäº†
```python
def extract_mesh_unified(self, input_file: str, model_name: str, output_dir: str, **kwargs) -> Dict[str, Any]:
    """çµ±ä¸€å‘½åè¦å‰‡å¯¾å¿œãƒ¡ãƒƒã‚·ãƒ¥æŠ½å‡º"""
    
    # 1. åŸæµå‡¦ç†å®Ÿè¡Œ
    success, logs = self._execute_original_extract(input_file, output_dir, **kwargs)
    
    if success:
        # 2. çµ±ä¸€å‘½åè¦å‰‡é©ç”¨
        dir_manager = FixedDirectoryManager(...)
        original_output = Path(output_dir) / "raw_data.npz"
        unified_output = dir_manager.ensure_unified_output('step1', 'mesh_npz', original_output)
        
        return {
            'success': True,
            'unified_files': {'mesh_npz': str(unified_output)},
            'original_files': {'raw_data_npz': str(original_output)},
            'logs': logs
        }
```

#### ğŸ¦´ `unified_skeleton_streamlined.py` ä½œæˆå®Œäº†
```python
def generate_skeleton_unified(self, model_name: str, mesh_file: str, output_dir: str, gender: str = "neutral") -> Dict[str, Any]:
    """çµ±ä¸€å‘½åè¦å‰‡å¯¾å¿œã‚¹ã‚±ãƒ«ãƒˆãƒ³ç”Ÿæˆ"""
    
    # 1. åŸæµå‡¦ç†å®Ÿè¡Œ
    success, logs = self._execute_original_skeleton_generation(...)
    
    if success:
        # 2. çµ±ä¸€å‘½åè¦å‰‡é©ç”¨
        dir_manager = FixedDirectoryManager(...)
        
        # FBXã¨NPZã®çµ±ä¸€åã‚³ãƒ”ãƒ¼
        unified_fbx = dir_manager.ensure_unified_output('step2', 'skeleton_fbx', original_fbx)
        unified_npz = dir_manager.ensure_unified_output('step2', 'skeleton_npz', original_npz)
        
        return {
            'success': True,
            'unified_files': {
                'skeleton_fbx': str(unified_fbx),
                'skeleton_npz': str(unified_npz)
            },
            'logs': logs
        }
```

### 3. çµ±ä¸€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ç¢ºç«‹

#### ğŸ“ æ±ºå®šçš„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
```
/app/pipeline_work/{model_name}/
â”œâ”€â”€ 00_asset_preservation/         # Step0: å…ƒãƒ‡ãƒ¼ã‚¿ä¿å­˜
â”œâ”€â”€ 01_extracted_mesh/             # Step1: ãƒ¡ãƒƒã‚·ãƒ¥æŠ½å‡º
â”‚   â””â”€â”€ {model_name}_mesh.npz      # âœ… çµ±ä¸€å‘½å
â”œâ”€â”€ 02_skeleton/                   # Step2: ã‚¹ã‚±ãƒ«ãƒˆãƒ³ç”Ÿæˆ
â”‚   â”œâ”€â”€ {model_name}_skeleton.fbx  # âœ… çµ±ä¸€å‘½å
â”‚   â””â”€â”€ {model_name}_skeleton.npz  # âœ… çµ±ä¸€å‘½å
â”œâ”€â”€ 03_skinning/                   # Step3: ã‚¹ã‚­ãƒ‹ãƒ³ã‚°é©ç”¨
â”‚   â”œâ”€â”€ {model_name}_skinned.fbx   # âœ… çµ±ä¸€å‘½å
â”‚   â””â”€â”€ {model_name}_skinning.npz  # âœ… çµ±ä¸€å‘½å
â”œâ”€â”€ 04_merge/                      # Step4: éª¨ãƒ»ã‚¹ã‚­ãƒ³çµ±åˆ
â”‚   â””â”€â”€ {model_name}_merged.fbx    # âœ… çµ±ä¸€å‘½å
â””â”€â”€ 05_blender_integration/        # Step5: æœ€çµ‚æˆæœç‰©
    â””â”€â”€ {model_name}_rigged.fbx    # âœ… çµ±ä¸€å‘½åï¼ˆæœ€çµ‚æˆæœç‰©ï¼‰
```

## ğŸ¯ æ•´æµã®æŠ€è¡“çš„åŠ¹æœ

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®åŠ‡çš„æ”¹å–„
```bash
# æ”¹ä¿®å‰: è¤‡é›‘ã§äºˆæ¸¬å›°é›£
è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ« â†’ ä½•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼Ÿ â†’ æ‰‹å‹•ãƒãƒ¼ã‚¸ï¼Ÿ

# æ”¹ä¿®å¾Œ: ã‚·ãƒ³ãƒ—ãƒ«ã§äºˆæ¸¬å¯èƒ½
bird.glb â†’ [1ã‚¯ãƒªãƒƒã‚¯] â†’ bird_rigged.fbx â†’ å³åº§ã«åˆ©ç”¨å¯èƒ½
```

### 2. é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Š
```bash
# æ”¹ä¿®å‰: ãƒ‡ãƒãƒƒã‚°å›°é›£
"predict_skeleton.npz ãŒè¦‹ã¤ã‹ã‚‰ãªã„" â†’ ã©ã“ã«ã‚ã‚‹ï¼Ÿ

# æ”¹ä¿®å¾Œ: ãƒ‡ãƒãƒƒã‚°å®¹æ˜“
"bird_skeleton.npz ãŒè¦‹ã¤ã‹ã‚‰ãªã„" â†’ 02_skeleton/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
```

### 3. ã‚·ã‚¹ãƒ†ãƒ å …ç‰¢æ€§ã®å‘ä¸Š
```python
# æ”¹ä¿®å‰: è¤‡é›‘ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
å¤šæ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ è¤‡é›‘ãªã‚¨ãƒ©ãƒ¼å‡¦ç†

# æ”¹ä¿®å¾Œ: ã‚·ãƒ³ãƒ—ãƒ«ãªçŠ¶æ…‹ç®¡ç†
çµ±ä¸€ãƒ•ã‚¡ã‚¤ãƒ«å â†’ äºˆæ¸¬å¯èƒ½ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼ + ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§
```

## ğŸ”„ æ¼¸é€²çš„çµ±ä¸€æˆ¦ç•¥

### Phase 1: åŸºç›¤æ•´å‚™å®Œäº† âœ…
- [x] `UnifiedNamingConvention` ã‚¯ãƒ©ã‚¹å®Ÿè£…
- [x] `FixedDirectoryManager` çµ±ä¸€å¯¾å¿œ
- [x] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½å®Ÿè£…

### Phase 2: Orchestratorçµ±ä¸€å®Œäº† âœ…
- [x] `unified_extract_streamlined.py` å®Ÿè£…
- [x] `unified_skeleton_streamlined.py` å®Ÿè£…
- [x] çµ±ä¸€ãƒ¡ã‚½ãƒƒãƒ‰ (`*_unified`) å®Ÿè£…

### Phase 3: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ•´æµï¼ˆæ¬¡å›å®Ÿè£…äºˆå®šï¼‰
- [ ] `quick_inference_skeleton_articulationxl_ar_256.yaml` ä¿®æ­£
- [ ] `quick_inference_unirig_skin.yaml` é‡è¤‡å®šç¾©é™¤å»
- [ ] Shell Scriptçµ±ä¸€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ

### Phase 4: app.pyçµ±åˆæ•´æµï¼ˆæ¬¡å›å®Ÿè£…äºˆå®šï¼‰
- [ ] çµ±ä¸€Orchestratorä½¿ç”¨ã¸ã®å¤‰æ›´
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½æ”¹ä¿®
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ±ä¸€åŒ–

## ğŸš¨ é‡è¦ãªè¨­è¨ˆåˆ¤æ–­

### 1. åŸæµå‡¦ç†äº’æ›æ€§ã®ä¿æŒ
```python
# æˆ¦ç•¥: åŸæµå‡¦ç†ã¯å¤‰æ›´ã›ãšã€å‡ºåŠ›å¾Œã«çµ±ä¸€åã§ã‚³ãƒ”ãƒ¼
# ç†ç”±: æ—¢å­˜ã®å‹•ä½œç¢ºèªæ¸ˆã¿å‡¦ç†ã‚’ä¿è­·
original_output = execute_original_flow(...)
unified_output = ensure_unified_output(original_output)
```

### 2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã«ã‚ˆã‚‹æ¼¸é€²çš„ç§»è¡Œ
```python
# æˆ¦ç•¥: çµ±ä¸€åå„ªå…ˆã€ãƒ¬ã‚¬ã‚·ãƒ¼åãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
# ç†ç”±: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®äº’æ›æ€§ä¿æŒ
unified_file = find_unified_file()
if not unified_file:
    legacy_file = find_legacy_file()  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
```

### 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸­å¿ƒã®æœ€çµ‚æˆæœç‰©è¨­è¨ˆ
```
æœ€é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«: {model_name}_rigged.fbx
- UVåº§æ¨™å®Œå…¨è»¢é€æ¸ˆã¿
- ãƒãƒ†ãƒªã‚¢ãƒ«ãƒ»ãƒ†ã‚¯ã‚¹ãƒãƒ£çµ±åˆæ¸ˆã¿
- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ»ã‚¹ã‚­ãƒ³ã‚¦ã‚§ã‚¤ãƒˆé©ç”¨æ¸ˆã¿
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯èƒ½çŠ¶æ…‹
```

## ğŸ“‹ æ¬¡å›å®Ÿè£…é …ç›®

### 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ•´æµ
```yaml
# quick_inference_skeleton_articulationxl_ar_256.yaml
writer:
  export_fbx: skeleton_model      # çµ±ä¸€å
  export_npz: predict_skeleton    # åŸæµäº’æ›

# quick_inference_unirig_skin.yaml
writer:
  export_npz: predict_skin        # çµ±ä¸€åï¼ˆé‡è¤‡å®šç¾©é™¤å»ï¼‰
  export_fbx: skinned_model       # çµ±ä¸€å
```

### 2. Shell Scriptçµ±ä¸€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ
```bash
# generate_skeleton.sh
model_name="$3"  # æ–°è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
# çµ±ä¸€å‘½åè¦å‰‡é©ç”¨å‡¦ç†è¿½åŠ 

# generate_skin.sh  
model_name="$4"  # æ–°è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
# çµ±ä¸€å‘½åè¦å‰‡é©ç”¨å‡¦ç†è¿½åŠ 
```

### 3. app.pyçµ±åˆæ•´æµ
```python
# çµ±ä¸€Orchestratorä½¿ç”¨
from src.pipeline.unified_extract_streamlined import UnifiedExtractor
from src.pipeline.unified_skeleton_streamlined import UnifiedSkeletonOrchestrator

# ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
download_files = dir_manager.get_user_download_files()
# æœ€çµ‚æˆæœç‰©: {model_name}_rigged.fbx
```

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹æœ€çµ‚åŠ¹æœ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“
```
å…¥åŠ›: bird.glb
å‡¦ç†: [1ã‚¯ãƒªãƒƒã‚¯ ãƒªã‚®ãƒ³ã‚°å®Ÿè¡Œ]
å‡ºåŠ›: bird_rigged.fbx â† ã™ãã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚½ãƒ•ãƒˆã§åˆ©ç”¨å¯èƒ½
```

### é–‹ç™ºä½“é¨“
```
ã‚¨ãƒ©ãƒ¼: "bird_skeleton.npz ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
è§£æ±º: /app/pipeline_work/bird/02_skeleton/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
ãƒ‡ãƒãƒƒã‚°: äºˆæ¸¬å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«é…ç½®ã€çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

### ã‚·ã‚¹ãƒ†ãƒ å …ç‰¢æ€§
```
çŠ¶æ…‹ç®¡ç†: ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒ™ãƒ¼ã‚¹ã®æ˜ç¢ºãªçŠ¶æ…‹åˆ¤å®š
ã‚¨ãƒ©ãƒ¼å‡¦ç†: çµ±ä¸€ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
æ‹¡å¼µæ€§: æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ æ™‚ã‚‚çµ±ä¸€å‘½åè¦å‰‡æº–æ‹ 
```

---

**æœ¬å®Ÿè£…ã«ã‚ˆã‚Šã€UniRigã¯æŠ€è¡“çš„è¤‡é›‘ã•ã‚’å®Œå…¨ã«éš è”½ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã‚·ãƒ³ãƒ—ãƒ«ã§äºˆæ¸¬å¯èƒ½ãª3Dãƒªã‚®ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¨ãªã‚Šã¾ã™ã€‚æ¬¡å›ã®å®Ÿè£…ã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ•´æµã¨app.pyçµ±åˆã‚’å®Œäº†ã—ã€å®Œå…¨ãªæ•´æµã‚’å®Ÿç¾ã—ã¾ã™ã€‚**
